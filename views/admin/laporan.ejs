<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Lengkap - SIPANDI</title>
    <link rel="stylesheet" href="/css/output.css">
    <link rel="icon" type="image/png" href="/images/logo-biro-organisasi.jpg">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* CSS Khusus Print - Menyembunyikan elemen lain saat mencetak */
        @media print {
            body * {
                visibility: hidden;
            }
            .printable-area, .printable-area * {
                visibility: visible;
            }
            .printable-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>

<body class="bg-gray-100 font-sans antialiased">
    <div class="flex h-screen overflow-hidden">
        <%- include('../partials/sidebaradmin', { page: 'laporan' }) %>
        <div class="relative flex flex-col flex-1 overflow-y-auto overflow-x-hidden">
            <%- include('../partials/header', { pageTitle: 'Pusat Laporan & Arsip' }) %>

            <main class="w-full flex-grow p-6">
                
                <div class="mb-6 border-b border-gray-200">
                    <ul class="flex flex-wrap -mb-px text-sm font-medium text-center" id="reportTabs">
                        <% if (user.role === 'admin' || user.role === 'admin_atk') { %>
                        <li class="mr-2">
                            <button onclick="switchTab('pengajuan')" id="tab-pengajuan" class="inline-block p-4 text-sipandi-green-600 border-b-2 border-sipandi-green-600 rounded-t-lg active hover:text-sipandi-green-600 hover:border-sipandi-green-600 transition-all">
                                üíº Laporan Pengajuan Barang
                            </button>
                        </li>
                        <li class="mr-2">
                            <button onclick="switchTab('stok')" id="tab-stok" class="inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300 transition-all">
                                üì¶ Laporan Stok Barang
                            </button>
                        </li>
                        <% } %>

                        <% if (user.role === 'admin' || user.role === 'admin_validasi_jp') { %>
                        <li class="mr-2">
                            <button onclick="switchTab('jp')" id="tab-jp" class="inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300 transition-all">
                                üéì Laporan Validasi JP
                            </button>
                        </li>
                        <% } %>

                        <% if (user.role === 'admin') { %>
                        <li class="mr-2">
                            <button onclick="switchTab('users')" id="tab-users" class="inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300 transition-all">
                                üë• Laporan Data Pegawai
                            </button>
                        </li>
                        <% } %>
                    </ul>
                </div>

                <div id="content-pengajuan" class="report-section">
                    <div class="bg-white rounded-xl shadow-md p-6 printable-area">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">Laporan Pengajuan Barang</h3>
                                <p class="text-sm text-gray-500">Rekapitulasi seluruh pengajuan barang masuk.</p>
                            </div>
                            <div class="flex gap-2 no-print">
                                <button onclick="exportToExcel('tablePengajuan', 'Laporan_Pengajuan_Barang')" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-green-700 flex items-center gap-2">
                                    <span>üì•</span> Excel
                                </button>
                                <button onclick="printArea('content-pengajuan')" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-700 flex items-center gap-2">
                                    <span>üñ®Ô∏è</span> Print / PDF
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table id="tablePengajuan" class="w-full text-sm text-left text-gray-500 border border-gray-200">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50 border-b">
                                    <tr>
                                        <th class="px-6 py-3 border-r">Tanggal</th>
                                        <th class="px-6 py-3 border-r">Nama Pegawai</th>
                                        <th class="px-6 py-3 border-r">Unit Kerja</th>
                                        <th class="px-6 py-3 border-r">Barang</th>
                                        <th class="px-6 py-3 border-r">Status</th>
                                        <th class="px-6 py-3">Catatan Admin</th>
                                    </tr>
                                </thead>
                                <tbody id="bodyPengajuan">
                                    <tr><td colspan="6" class="text-center py-4">Memuat data...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="content-stok" class="report-section hidden">
                    <div class="bg-white rounded-xl shadow-md p-6 printable-area">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">Laporan Stok Barang (ATK)</h3>
                                <p class="text-sm text-gray-500">Data ketersediaan barang inventaris saat ini.</p>
                            </div>
                            <div class="flex gap-2 no-print">
                                <button onclick="exportToExcel('tableStok', 'Laporan_Stok_Barang')" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-green-700 flex items-center gap-2">
                                    <span>üì•</span> Excel
                                </button>
                                <button onclick="printArea('content-stok')" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-700 flex items-center gap-2">
                                    <span>üñ®Ô∏è</span> Print / PDF
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table id="tableStok" class="w-full text-sm text-left text-gray-500 border border-gray-200">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50 border-b">
                                    <tr>
                                        <th class="px-6 py-3 border-r">Nama Barang</th>
                                        <th class="px-6 py-3 border-r">Stok Saat Ini</th>
                                        <th class="px-6 py-3 border-r">Satuan</th>
                                        <th class="px-6 py-3 border-r">Status Ketersediaan</th>
                                        <th class="px-6 py-3">Terakhir Update</th>
                                    </tr>
                                </thead>
                                <tbody id="bodyStok">
                                    <tr><td colspan="5" class="text-center py-4">Memuat data...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="content-jp" class="report-section hidden">
                    <div class="bg-white rounded-xl shadow-md p-6 printable-area">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">Laporan Validasi JP ASN</h3>
                                <p class="text-sm text-gray-500">Rekapitulasi bukti pengembangan kompetensi ASN.</p>
                            </div>
                            <div class="flex gap-2 no-print">
                                <button onclick="exportToExcel('tableJp', 'Laporan_Validasi_JP')" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-green-700 flex items-center gap-2">
                                    <span>üì•</span> Excel
                                </button>
                                <button onclick="printArea('content-jp')" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-700 flex items-center gap-2">
                                    <span>üñ®Ô∏è</span> Print / PDF
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table id="tableJp" class="w-full text-sm text-left text-gray-500 border border-gray-200">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50 border-b">
                                    <tr>
                                        <th class="px-6 py-3 border-r">Nama ASN</th>
                                        <th class="px-6 py-3 border-r">NIP</th>
                                        <th class="px-6 py-3 border-r">Nama Sertifikat</th>
                                        <th class="px-6 py-3 border-r">Jumlah JP</th>
                                        <th class="px-6 py-3 border-r">Periode</th>
                                        <th class="px-6 py-3 border-r">Status</th>
                                        <th class="px-6 py-3">Tanggal Submit</th>
                                    </tr>
                                </thead>
                                <tbody id="bodyJp">
                                    <tr><td colspan="7" class="text-center py-4">Memuat data...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="content-users" class="report-section hidden">
                    <div class="bg-white rounded-xl shadow-md p-6 printable-area">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">Laporan Data Pegawai</h3>
                                <p class="text-sm text-gray-500">Daftar seluruh akun pengguna sistem.</p>
                            </div>
                            <div class="flex gap-2 no-print">
                                <button onclick="exportToExcel('tableUsers', 'Laporan_Data_Pegawai')" class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-green-700 flex items-center gap-2">
                                    <span>üì•</span> Excel
                                </button>
                                <button onclick="printArea('content-users')" class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-700 flex items-center gap-2">
                                    <span>üñ®Ô∏è</span> Print / PDF
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table id="tableUsers" class="w-full text-sm text-left text-gray-500 border border-gray-200">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50 border-b">
                                    <tr>
                                        <th class="px-6 py-3 border-r">Nama Lengkap</th>
                                        <th class="px-6 py-3 border-r">NIP (Username)</th>
                                        <th class="px-6 py-3 border-r">Role / Jabatan</th>
                                        <th class="px-6 py-3 border-r">Unit Kerja</th>
                                        <th class="px-6 py-3">Email</th>
                                    </tr>
                                </thead>
                                <tbody id="bodyUsers">
                                    <tr><td colspan="5" class="text-center py-4">Memuat data...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </main>
            <%- include('../partials/footer') %>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Load all data on init based on role
            const userRole = "<%= user.role %>";
            
            if(['admin', 'admin_atk'].includes(userRole)) {
                loadPengajuan();
                loadStok();
            }
            if(['admin', 'admin_validasi_jp'].includes(userRole)) {
                loadJp();
            }
            if(userRole === 'admin') {
                loadUsers();
            }
        });

        // --- TAB SWITCHING ---
        function switchTab(tabName) {
            // Hide all sections
            document.querySelectorAll('.report-section').forEach(el => el.classList.add('hidden'));
            // Show selected section
            document.getElementById(`content-${tabName}`).classList.remove('hidden');

            // Reset tab styles
            document.querySelectorAll('#reportTabs button').forEach(btn => {
                btn.classList.remove('text-sipandi-green-600', 'border-sipandi-green-600');
                btn.classList.add('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
            });
            // Set active tab style
            const activeTab = document.getElementById(`tab-${tabName}`);
            activeTab.classList.remove('border-transparent', 'hover:text-gray-600', 'hover:border-gray-300');
            activeTab.classList.add('text-sipandi-green-600', 'border-sipandi-green-600');
        }

        // --- DATA LOADING ---

        async function loadPengajuan() {
            try {
                // Menggunakan API List yang sudah ada (bukan rekap count)
                const res = await fetch('/admin/pengajuan/list?status=all&bidang=all'); 
                const data = await res.json();
                const tbody = document.getElementById('bodyPengajuan');
                
                if(data.success && data.pengajuans.length > 0) {
                    tbody.innerHTML = data.pengajuans.map(p => `
                        <tr class="bg-white border-b hover:bg-gray-50">
                            <td class="px-6 py-4">${new Date(p.tanggal_pengajuan).toLocaleDateString('id-ID')}</td>
                            <td class="px-6 py-4 font-medium text-gray-900">${p.user.nama} <br><span class="text-xs text-gray-500">${p.user.nip}</span></td>
                            <td class="px-6 py-4">${p.user.unit_kerja || '-'}</td>
                            <td class="px-6 py-4">
                                <ul class="list-disc list-inside text-xs">
                                    ${p.items.map(i => `<li>${i.nama_barang} (${i.jumlah_diminta} ${i.satuan})</li>`).join('')}
                                </ul>
                            </td>
                            <td class="px-6 py-4">
                                <span class="px-2 py-1 font-semibold leading-tight rounded-full ${p.status === 'disetujui' ? 'bg-green-100 text-green-700' : p.status === 'ditolak' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'} text-xs">
                                    ${p.status.toUpperCase()}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-xs italic">${p.catatan_admin || '-'}</td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4">Tidak ada data pengajuan.</td></tr>';
                }
            } catch (error) { console.error(error); }
        }

        async function loadStok() {
            try {
                const res = await fetch('/admin/inventory/list'); 
                const data = await res.json();
                const tbody = document.getElementById('bodyStok');

                if(data.success && data.barangs.length > 0) {
                    tbody.innerHTML = data.barangs.map(b => `
                        <tr class="bg-white border-b hover:bg-gray-50">
                            <td class="px-6 py-4 font-medium text-gray-900">${b.nama_barang}</td>
                            <td class="px-6 py-4 font-bold ${b.quantity <= b.threshold_stok_habis ? 'text-red-600' : 'text-gray-800'}">${b.quantity}</td>
                            <td class="px-6 py-4">${b.satuan}</td>
                            <td class="px-6 py-4">${b.status_stok}</td>
                            <td class="px-6 py-4">${new Date(b.updatedAt).toLocaleDateString('id-ID')}</td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4">Tidak ada data stok.</td></tr>';
                }
            } catch (error) { console.error(error); }
        }

        async function loadJp() {
            try {
                const res = await fetch('/admin/jp/list?status=all&bidang=all&bulan=all&tahun=all'); 
                const data = await res.json();
                const tbody = document.getElementById('bodyJp');

                if(data.success && data.submissions.length > 0) {
                    tbody.innerHTML = data.submissions.map(s => `
                        <tr class="bg-white border-b hover:bg-gray-50">
                            <td class="px-6 py-4 font-medium text-gray-900">${s.user.nama}</td>
                            <td class="px-6 py-4">${s.user.nip}</td>
                            <td class="px-6 py-4">${s.nama_sertif}</td>
                            <td class="px-6 py-4 text-center font-bold">${s.jumlah_jp}</td>
                            <td class="px-6 py-4">${s.bulan} ${s.tahun}</td>
                            <td class="px-6 py-4">
                                <span class="px-2 py-1 font-semibold leading-tight rounded-full ${s.status === 'diterima' ? 'bg-green-100 text-green-700' : s.status === 'ditolak' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'} text-xs">
                                    ${s.status.toUpperCase()}
                                </span>
                            </td>
                            <td class="px-6 py-4">${new Date(s.createdAt).toLocaleDateString('id-ID')}</td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">Tidak ada data JP.</td></tr>';
                }
            } catch (error) { console.error(error); }
        }

        async function loadUsers() {
            try {
                const res = await fetch('/admin/users/list?role=all'); 
                const data = await res.json();
                const tbody = document.getElementById('bodyUsers');

                if(data.success && data.users.length > 0) {
                    tbody.innerHTML = data.users.map(u => `
                        <tr class="bg-white border-b hover:bg-gray-50">
                            <td class="px-6 py-4 font-medium text-gray-900">${u.name}</td>
                            <td class="px-6 py-4">${u.username}</td>
                            <td class="px-6 py-4 uppercase font-bold text-xs">${u.role.replace(/_/g, ' ')}</td>
                            <td class="px-6 py-4">${u.unit_kerja || '-'}</td>
                            <td class="px-6 py-4">${u.email || '-'}</td>
                        </tr>
                    `).join('');
                } else {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4">Tidak ada data pegawai.</td></tr>';
                }
            } catch (error) { console.error(error); }
        }

        // --- FITUR DOWNLOAD EXCEL ---
        function exportToExcel(tableId, filename = 'download') {
            const table = document.getElementById(tableId);
            const rows = table.querySelectorAll('tr');
            let csvContent = "";

            rows.forEach(row => {
                const cols = row.querySelectorAll('th, td');
                const rowData = [];
                cols.forEach(col => {
                    // Bersihkan text dari enter/spasi berlebih dan quote
                    let data = col.innerText.replace(/(\r\n|\n|\r)/gm, " ").replace(/"/g, '""').trim();
                    rowData.push(`"${data}"`);
                });
                csvContent += rowData.join(",") + "\r\n";
            });

            // Create blob and download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            
            // Tanggal sekarang untuk nama file
            const date = new Date().toISOString().slice(0,10);
            
            link.setAttribute("href", url);
            link.setAttribute("download", `${filename}_${date}.csv`); // CSV bisa dibuka di Excel
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- FITUR PRINT ---
        function printArea(areaId) {
            // Sembunyikan semua section dulu
            document.querySelectorAll('.report-section').forEach(el => el.classList.add('hidden'));
            
            // Tampilkan hanya area yang mau diprint
            const area = document.getElementById(areaId);
            area.classList.remove('hidden');
            
            window.print();

            // Kembalikan tampilan (tampilkan tab aktif lagi)
            // Cek tab mana yang aktif (berdasarkan class text-sipandi-green-600)
            const activeTabBtn = document.querySelector('#reportTabs button.text-sipandi-green-600');
            if(activeTabBtn) {
                const tabName = activeTabBtn.id.replace('tab-', '');
                switchTab(tabName);
            }
        }
    </script>
</body>
</html>